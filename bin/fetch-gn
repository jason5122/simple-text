#!/usr/bin/env python3
import os
import platform
import sys
import tempfile
import zipfile
from urllib.request import urlopen


os.chdir(os.path.join(os.path.dirname(__file__), os.pardir))

OS = {"darwin": "mac", "linux": "linux", "linux2": "linux", "win32": "windows"}[sys.platform]
cpu = {"aarch64": "arm64", "amd64": "amd64", "arm64": "arm64", "x86_64": "amd64"}[platform.machine().lower()]
gn = "gn.exe" if OS == "windows" else "gn"
gn_path = os.path.join("bin", gn)
gn_zip = os.path.join(tempfile.mkdtemp(), "gn.zip")
rev = "103f8b437f5e791e0aef9d5c372521a5d675fabb"

print(f"Fetching {gn} at {rev} for {OS} {cpu}")

with open(gn_zip, "wb") as f:
    url = f"https://chrome-infra-packages.appspot.com/dl/gn/gn/{OS}-{cpu}/+/git_revision:{rev}"
    f.write(urlopen(url).read())

with zipfile.ZipFile(gn_zip, "r") as f:
    f.extract(gn, "bin")

if OS != "windows":
    os.chmod(gn_path, 0o755)
